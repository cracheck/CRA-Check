using CRA_Check.Models;
using CRA_Check.Tools.Parser;
using GrypeCLIWrapper;
using System.IO;

namespace CRA_Check.Tools.VulnerabilityScanners
{
    public class GrypeScanner : IVulnerabilityScanner
    {
        private readonly string SBOM_TEMP_FILENAME = "sbom.json";
        private GrypeCLIWrapper.GrypeCLIWrapper _grypeCLIWrapper;

        public GrypeScanner(string grypePath)
        {
            _grypeCLIWrapper = new GrypeCLIWrapper.GrypeCLIWrapper(grypePath);
        }

        public Task<string> UpdateDatabase()
        {
            return _grypeCLIWrapper.UpdateDatabase();
        }

        public Task<string> ScanVulnerability(string sourcePath)
        {
            return  _grypeCLIWrapper.ScanVulnerability(sourcePath, OutputFormatType.CYCLONEDX_JSON);
        }

        public Task<string> ScanVulnerability(Release release)
        {
            string sbomFilename = Path.Combine(Path.GetTempPath(), SBOM_TEMP_FILENAME);

            File.WriteAllText(sbomFilename, release.Sbom);

            return ScanVulnerability(sbomFilename);
        }

        public Task<Version> GetVersion()
        {
            return _grypeCLIWrapper.GetVersion();
        }
    }
}
