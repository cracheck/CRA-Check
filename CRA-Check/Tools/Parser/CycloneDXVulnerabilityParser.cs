using System.Text.Json;
using CRA_Check.Models;

namespace CRA_Check.Tools.Parser
{
    public static class CycloneDXVulnerabilityParser
    {
        public static List<Vulnerability> Parse(string json)
        {
            List<Vulnerability> vulnerabilities = new List<Vulnerability>();

            JsonDocument document = JsonDocument.Parse(json);
            JsonElement root = document.RootElement;

            if (root.TryGetProperty("vulnerabilities", out var vulnerabilitiesJson))
            {
                foreach (var vulnerabilityJson in vulnerabilitiesJson.EnumerateArray())
                {
                    Vulnerability vulnerability = new Vulnerability();

                    vulnerability.VulnerabilityId = vulnerabilityJson.GetProperty("id").GetString();
                    vulnerability.Description = vulnerabilityJson.GetProperty("description").GetString();
                    vulnerability.SourceName = vulnerabilityJson.GetProperty("source").GetProperty("name").GetString();
                    vulnerability.SourceUrl = vulnerabilityJson.GetProperty("source").GetProperty("url").GetString();

                    foreach (var ratingJson in vulnerabilityJson.GetProperty("ratings").EnumerateArray())
                    {
                        var rating = new Rating();

                        if (ratingJson.TryGetProperty("score", out var scoreJson))
                        {
                            rating.Score = scoreJson.GetDouble();
                        }

                        string severityStr = ratingJson.GetProperty("severity").GetString();
                        rating.Severity = Enum.Parse<SeverityLevel>(severityStr);

                        rating.Method = ratingJson.GetProperty("method").GetString();

                        if (ratingJson.TryGetProperty("vector", out var vectorJson))
                        {
                            rating.Vector = vectorJson.GetString();
                        }

                        vulnerability.Ratings.Add(rating);
                    }

                    vulnerabilities.Add(vulnerability);
                }
            }

            return vulnerabilities;
        }
    }
}
